{% extends "base.html" %}

{% block title %}Team Dashboard - Bite Me Buddy{% endblock %}

{% block content %}
<div class="mb-4">
    <h2 class="mb-3">
        <i class="fas fa-tachometer-alt me-2"></i>Team Member Dashboard
    </h2>
    <p class="lead mb-0">Welcome, {{ team_member.name }}! Manage your deliveries efficiently.</p>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Assigned Orders</h6>
                        <h2 class="mb-0">{{ orders|length }}</h2>
                    </div>
                    <i class="fas fa-shopping-cart fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Today's Sessions</h6>
                        <h2 class="mb-0">{{ today_sessions|length }}</h2>
                    </div>
                    <i class="fas fa-clock fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Online Status</h6>
                        <h2 class="mb-0">
                            {% if today_sessions and not today_sessions[0].logout_time %}
                                Online
                            {% else %}
                                Offline
                            {% endif %}
                        </h2>
                    </div>
                    <i class="fas fa-signal fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assigned Orders -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-list-alt me-2"></i>Assigned Orders
        </h5>
        <button class="btn btn-light btn-sm" onclick="loadOrders()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
    </div>
    <div class="card-body">
        <div id="ordersList" hx-get="/api/team/orders" hx-trigger="load">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading orders...</p>
            </div>
        </div>
    </div>
</div>

<!-- New Plans / Today's Plan -->
<div class="card">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i>Today's Plan
        </h5>
    </div>
    <div class="card-body">
        <div id="teamPlans" hx-get="/api/team/plans" hx-trigger="load">
            <div class="text-center py-3">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading today's plan...</p>
            </div>
        </div>
    </div>
</div>

<!-- Delivery Guide -->
<div class="alert alert-info mt-4">
    <h5>
        <i class="fas fa-info-circle me-2"></i>Delivery Instructions
    </h5>
    <ul class="mb-0">
        <li>Always verify customer's phone number before delivery</li>
        <li>Use OTP verification for every delivery</li>
        <li>Handle food packages with care</li>
        <li>Maintain professional behavior with customers</li>
        <li>Report any issues immediately to admin</li>
    </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadOrders() {
    const ordersList = document.getElementById('ordersList');
    ordersList.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Refreshing orders...</p>
        </div>
    `;
    
    htmx.trigger('#ordersList', 'load');
}

function generateOTP(orderId) {
    if (!confirm('Generate OTP for this order? OTP will be sent to customer via SMS.')) {
        return;
    }
    
    fetch(`/api/orders/${orderId}/generate-otp`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            // Show OTP verification form
            showOTPForm(orderId);
        } else {
            alert('Failed to generate OTP');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to generate OTP');
    });
}

function showOTPForm(orderId) {
    const orderCard = document.querySelector(`#order-${orderId}`);
    if (orderCard) {
        orderCard.innerHTML += `
            <div class="mt-3 p-3 border rounded">
                <h6>OTP Verification</h6>
                <div class="input-group">
                    <input type="text" class="form-control" id="otp-${orderId}" 
                           placeholder="Enter 4-digit OTP" maxlength="4">
                    <button class="btn btn-success" onclick="verifyOTP(${orderId})">
                        Verify & Complete
                    </button>
                </div>
                <small class="text-muted">Enter OTP received by customer</small>
            </div>
        `;
    }
}

function verifyOTP(orderId) {
    const otpInput = document.getElementById(`otp-${orderId}`);
    const otp = otpInput.value.trim();
    
    if (otp.length !== 4) {
        alert('Please enter 4-digit OTP');
        return;
    }
    
    fetch(`/api/orders/${orderId}/verify-otp`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `otp=${otp}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Delivery confirmed successfully!');
            loadOrders(); // Refresh orders list
        } else {
            alert(data.message || 'Invalid OTP');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to verify OTP');
    });
}
</script>
{% endblock %}
