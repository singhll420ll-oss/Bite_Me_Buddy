{% extends "base.html" %}

{% block title %}Checkout - Bite Me Buddy{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-shopping-cart me-2"></i>Checkout
                </h4>
            </div>
            <div class="card-body">
                <div id="cartItems">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading cart items...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-truck me-2"></i>Delivery Information
                </h5>
            </div>
            <div class="card-body">
                <form id="checkoutForm" hx-post="/api/orders" hx-target="body" hx-push-url="true">
                    <input type="hidden" id="service_id" name="service_id" value="{{ service.id if service else '' }}">
                    <input type="hidden" id="items_json" name="items_json">
                    
                    <div class="mb-3">
                        <label for="address" class="form-label">
                            <i class="fas fa-home me-1"></i>Delivery Address
                        </label>
                        <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
                        <small class="text-muted">Please provide complete address with landmarks</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="phone" class="form-label">
                            <i class="fas fa-phone me-1"></i>Phone Number
                        </label>
                        <input type="tel" class="form-control" id="phone" name="phone" required>
                        <small class="text-muted">We'll call this number if needed</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="special_instructions" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>Special Instructions (Optional)
                        </label>
                        <textarea class="form-control" id="special_instructions" name="special_instructions" rows="2"></textarea>
                        <small class="text-muted">Any specific instructions for delivery</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Your order will be delivered within 30-45 minutes.
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg" id="placeOrderBtn" disabled>
                            <i class="fas fa-paper-plane me-2"></i>Place Order
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-receipt me-2"></i>Order Summary
                </h5>
            </div>
            <div class="card-body">
                <div id="orderSummary">
                    <div class="text-center text-muted">
                        <p>No items in cart</p>
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <h5>Total:</h5>
                    <h5>₹<span id="totalAmount">0.00</span></h5>
                </div>
                
                <div class="mt-4">
                    <h6>
                        <i class="fas fa-shield-alt me-2 text-success"></i>
                        Secure Payment
                    </h6>
                    <small class="text-muted">
                        Your payment information is secure. We don't store any payment details.
                    </small>
                </div>
                
                <div class="mt-3">
                    <h6>
                        <i class="fas fa-clock me-2 text-primary"></i>
                        Delivery Time
                    </h6>
                    <small class="text-muted">
                        30-45 minutes from order confirmation
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadCartItems();
    
    // Load saved address if exists
    const savedAddress = localStorage.getItem('delivery_address');
    const savedPhone = localStorage.getItem('delivery_phone');
    
    if (savedAddress) {
        document.getElementById('address').value = savedAddress;
    }
    if (savedPhone) {
        document.getElementById('phone').value = savedPhone;
    }
    
    // Save address on input
    document.getElementById('address').addEventListener('input', function() {
        localStorage.setItem('delivery_address', this.value);
    });
    
    document.getElementById('phone').addEventListener('input', function() {
        localStorage.setItem('delivery_phone', this.value);
    });
});

async function loadCartItems() {
    try {
        const cartData = JSON.parse(sessionStorage.getItem('cart') || '[]');
        
        if (cartData.length === 0) {
            document.getElementById('cartItems').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-shopping-cart me-2"></i>
                    Your cart is empty. Please add items from the menu.
                </div>
                <div class="text-center mt-3">
                    <a href="/services" class="btn btn-primary">
                        <i class="fas fa-utensils me-2"></i>Browse Services
                    </a>
                </div>
            `;
            return;
        }
        
        // Get menu item details (in a real app, this would be an API call)
        let itemsHtml = '';
        let total = 0;
        
        for (const item of cartData) {
            // Fetch item details from server
            const response = await fetch(`/api/menu-items/${item.id}`);
            if (response.ok) {
                const itemData = await response.json();
                const itemTotal = itemData.price * item.quantity;
                total += itemTotal;
                
                itemsHtml += `
                    <div class="cart-item mb-3">
                        <div class="row align-items-center">
                            <div class="col-3">
                                <div class="bg-light rounded p-2 text-center">
                                    <i class="fas fa-hamburger fa-2x"></i>
                                </div>
                            </div>
                            <div class="col-6">
                                <h6 class="mb-1">${itemData.name}</h6>
                                <small class="text-muted">${itemData.description || ''}</small>
                            </div>
                            <div class="col-3 text-end">
                                <div class="text-muted">${item.quantity} × ₹${itemData.price.toFixed(2)}</div>
                                <h6 class="mt-1">₹${itemTotal.toFixed(2)}</h6>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        document.getElementById('cartItems').innerHTML = itemsHtml || `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Could not load cart items. Please try again.
            </div>
        `;
        
        // Update summary
        document.getElementById('totalAmount').textContent = total.toFixed(2);
        
        // Update order summary in sidebar
        const orderSummary = document.getElementById('orderSummary');
        if (cartData.length > 0) {
            orderSummary.innerHTML = `
                <div class="mb-2">
                    <small class="text-muted">${cartData.length} item(s)</small>
                </div>
                ${itemsHtml}
            `;
        }
        
        // Enable place order button
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        placeOrderBtn.disabled = false;
        
        // Set items JSON for form submission
        document.getElementById('items_json').value = JSON.stringify(cartData);
        
    } catch (error) {
        console.error('Error loading cart:', error);
        document.getElementById('cartItems').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading cart. Please try again.
            </div>
        `;
    }
}

// Form validation
document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    const address = document.getElementById('address').value.trim();
    const phone = document.getElementById('phone').value.trim();
    
    if (!address || address.length < 10) {
        e.preventDefault();
        alert('Please enter a valid delivery address (minimum 10 characters)');
        return;
    }
    
    if (!phone || phone.length < 10) {
        e.preventDefault();
        alert('Please enter a valid phone number');
        return;
    }
    
    // Clear cart after successful order
    sessionStorage.removeItem('cart');
    sessionStorage.removeItem('serviceId');
});
</script>
{% endblock %}
